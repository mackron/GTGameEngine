<!--
The editor is made up of 5 sections: Top, bottom, center, left and right. The center section is the main viewport.
-->

<style url="styles/theme.style" />

<include url="common-controls.xml" />
<include url="dialogs.xml"         />

<include url="menubar.xml"       />
<include url="combobox.xml"      />
<include url="file-explorer.xml" />
<include url="modeleditor.xml"   />
<include url="sandbox.xml"       />

<!-- In this section, the Editor table is created from the C++ code. Thus, ensure it is not re-created here. -->
<script>
<![CDATA[
]]>
</script>

<script>
<![CDATA[
    MenuBar_ModelEditor:MenuBar();
    file = MenuBar_ModelEditor:AppendItem("File");
    file.menu:AppendItem("Open..."):OnPressed(function()
        MenuBar_ModelEditor:CollapseMenu();
        OpenModelDialog:Show();
    end);
    file.menu:AppendSeparator();
    file.menu:AppendItem("Save");
    file.menu:AppendItem("Save As...");
    file.menu:AppendSeparator();
    file.menu:AppendItem("Exit"):OnPressed(function()
        Game.Close();
    end);
    
    MenuBar_ModelEditor:AppendItem("Edit");
    MenuBar_ModelEditor:AppendItem("View");
    
    
    
    MenuBar_Sandbox:MenuBar();
    insert = MenuBar_Sandbox:AppendItem("Insert");
    insert.menu:AppendItem("Ground Plane...");
    insert.menu:AppendSeparator();
    insert.menu:AppendItem("Dynamic Box...");
    insert.menu:AppendItem("Dynamic Sphere...");
    

    ModeSwitcher:ComboBox();
    ModeSwitcher:AppendItem("Model Editor"):OnPressed(function()
        Editor.SwitchToModelEditorMode();
    end);
    ModeSwitcher:AppendItem("Sandbox"):OnPressed(function()
        Editor.SwitchToSandboxMode();
    end);
    
    
    CommandTextBox:OnKeyDown(function(data)
        if data.key == 13 then                  -- Enter key
            if not Engine.ExecuteScript(CommandTextBox:GetText()) then
                CommandErrorBox:SetStyle("text-color", "#a66");
                CommandErrorBox:SetText(Engine.GetLastScriptError());
            else
                CommandErrorBox:SetStyle("text-color", "#999");
                CommandErrorBox:SetText("No errors.");
            end;
            
            CommandTextBox:SetText("");         -- Clear the box.
        else
            CommandErrorBox:SetText("");        -- Clears the output message.
        end;
    end);
]]>
</script>

<!-- Model Editor Dialog Box -->
<script>
<![CDATA[
    OpenModelDialog_FileExplorer:FileExplorer();

    btnOpenModelDialog_Open:OnPressed(function()
        OpenModelDialog:Hide();
    end);

    btnOpenModelDialog_Close:OnPressed(function()
        OpenModelDialog:Hide();
    end);
    
    
    
    checkModelEditor_ShowConvexDecomposition:CheckBox("Show in Viewport");
    
    checkModelEditor_ShowConvexDecomposition:OnChecked(function()
        Editor.ModelEditor.ShowConvexDecomposition();
    end);
    
    checkModelEditor_ShowConvexDecomposition:OnUnchecked(function()
        Editor.ModelEditor.HideConvexDecomposition();
    end);
    
    
    spinModelEditor_CD_CompacityWeight:LabeledSpinner(        "Compacity Weight",          0, 1000000, 1,   0.001);
    spinModelEditor_CD_VolumeWeight:LabeledSpinner(           "Volume Weight",             0, 1000000, 1,   500);
    spinModelEditor_CD_MinClusters:LabeledSpinner(            "Min Clusters",              1, 1000000, 1,   1);
    spinModelEditor_CD_VerticesPerCH:LabeledSpinner(          "Vertices Per CH",           0, 1000000, 10,  100);
    spinModelEditor_CD_Concavity:LabeledSpinner(              "Concavity",                 0, 1000000, 1,   0.001);
    spinModelEditor_CD_SmallThreshold:LabeledSpinner(         "Small Threshold",           0, 1000000, 1,   0.001);
    spinModelEditor_CD_ConnectedDistance:LabeledSpinner(      "Connected Distance",        0, 1000000, 1 ,  0.001);
    spinModelEditor_CD_SimplifiedTriangleCount:LabeledSpinner("Simplified Triangle Count", 0, 1000000, 100, 0);
    
    
    checkModelEditor_CD_AddExtraDistPoints:CheckBox("Add Extra Distance Points");
    checkModelEditor_CD_AddFacePoints:CheckBox("Add Face Points");
    
    
    btnModelEditor_ConvexDecomposition_Build:Button("Build"):OnPressed(function()
        btnModelEditor_ConvexDecomposition_Build:Disable();
            local compacityWeight         = spinModelEditor_CD_CompacityWeight:GetValue();
            local volumeWeight            = spinModelEditor_CD_VolumeWeight:GetValue();
            local minClusters             = spinModelEditor_CD_MinClusters:GetValue();
            local verticesPerCH           = spinModelEditor_CD_VerticesPerCH:GetValue();
            local concavity               = spinModelEditor_CD_Concavity:GetValue();
            local smallThreshold          = spinModelEditor_CD_SmallThreshold:GetValue();
            local connectedDistance       = spinModelEditor_CD_ConnectedDistance:GetValue();
            local simplifiedTriangleCount = spinModelEditor_CD_SimplifiedTriangleCount:GetValue();
            local addExtraDistPoints      = checkModelEditor_CD_AddExtraDistPoints:IsChecked();
            local addFacePoints           = checkModelEditor_CD_AddFacePoints:IsChecked();
            
            Editor.ModelEditor.BuildConvexDecomposition
            (
                compacityWeight,
                volumeWeight,
                minClusters,
                verticesPerCH,
                concavity,
                smallThreshold,
                connectedDistance,
                simplifiedTriangleCount,
                addExtraDistPoints,
                addFacePoints
            );
        btnModelEditor_ConvexDecomposition_Build:Enable();
    end);
]]>
</script>

<style>
    #EditorMain
    {
        width:   100%
        height:  100%
        
        flex-child-height:true
        
        background-color: #333
    }
    
    #EditorTopPanel
    {
        width:          100%
        height:         22px
        child-plane:    horizontal
        vertical-align: center
        padding-left:   4px
        
        border-bottom: 1px #2b2b2b
    }
    
    #EditorTopPanel_Left
    {
        width:          50%
        height:         100%
        child-plane:    horizontal
        vertical-align: center
    }
    
    #EditorTopPanel_Right
    {
        width:            50%
        height:           100%
        child-plane:      horizontal
        vertical-align:   center
        horizontal-align: right
    }
    
    
    #EditorBottomPanel
    {
        width:       100%
        height:      sidePanelSize
        child-plane: horizontal
        
        border-top: 1px #2b2b2b
        
        vertical-align: center
    }
    
    #EditorCenterPanel
    {
        height:      100%
        width:       100%
        child-plane: horizontal
    }
</style>


<div id="EditorMain">
    <div id="EditorTopPanel">
        <!--
        The top panel is split into two parts. The left side contains the normal menu bar. The right side contains additional stuff
        such as the mode switcher.
        -->
        <div id="EditorTopPanel_Left">
            <div id="MenuBar_ModelEditor" styleclass="menubar" style="visible:false;" />
            <div id="MenuBar_Sandbox"     styleclass="menubar" style="visible:false;" />
        </div>
        
        <div id="EditorTopPanel_Right" style="horizontal-align:right; vertical-align:center; padding-right:0px;">
            <div id="ModeSwitcher" styleclass="combobox" style="height:100%; margin-right:0px;" />
        </div>
    </div>

    <!--
    The center panel is where individual editting tools can use their own GUIs.
    -->
    <div id="EditorCenterPanel">
        <div id="ModelEditor" style="visible:false">
            <div id="ModelEditorLeftPanel" style="padding:4px; padding-top:12px;">
                <div id="ModelEditorPanel_ConvextDecomposition" style="padding:4px; padding-top:12px; border:1px #444; horizontal-align:left;">
                    <div style="positioning:relative; position-origin:inner-border; background-color:#333; width:auto; padding:4px 0px; text-color:#aaa; left:8px; top:-8px; font-style:bold;">Convex Decomposition</div>
                    
                    <div id="checkModelEditor_ShowConvexDecomposition" styleclass="checkbox" style="" />
                    
                    <div style="width:100%; height:1px; margin:0px 8px; background-color:#444;" />
                    
                    
                    <div id="spinModelEditor_CD_CompacityWeight"         styleclass="labeled-spinner" style="margin:0px 1px;" />
                    <div id="spinModelEditor_CD_VolumeWeight"            styleclass="labeled-spinner" style="margin:0px 1px;" />
                    <div id="spinModelEditor_CD_MinClusters"             styleclass="labeled-spinner" style="margin:0px 1px;" />
                    <div id="spinModelEditor_CD_VerticesPerCH"           styleclass="labeled-spinner" style="margin:0px 1px;" />
                    <div id="spinModelEditor_CD_Concavity"               styleclass="labeled-spinner" style="margin:0px 1px;" />
                    <div id="spinModelEditor_CD_SmallThreshold"          styleclass="labeled-spinner" style="margin:0px 1px;" />
                    <div id="spinModelEditor_CD_ConnectedDistance"       styleclass="labeled-spinner" style="margin:0px 1px;" />
                    <div id="spinModelEditor_CD_SimplifiedTriangleCount" styleclass="labeled-spinner" style="margin:0px 1px;" />
                    
                    
                    
                    <div id="checkModelEditor_CD_AddExtraDistPoints" styleclass="checkbox" style="margin-bottom:4px; margin-top:4px;" />
                    <div id="checkModelEditor_CD_AddFacePoints"      styleclass="checkbox" style="" />
                    
                    <div style="width:100%; height:1px; margin:0px 8px; background-color:#444;" />
                    
                    <div id="btnModelEditor_ConvexDecomposition_Build" styleclass="button" style="width:100%;" />
                </div>
            </div>
            <div id="ModelViewport">
            </div>
        </div>
        
        <div id="Sandbox" style="visible:false">
            <div id="SandboxLeftPanel">
            </div>
            <div id="SandboxViewport">
            </div>
        </div>
    </div>

    <div id="EditorBottomPanel">
        <div style="width:auto; margin-left:4px; margin-right:8px; text-color:#888;">Command:</div>
        <div id="CommandTextBox" styleclass="textbox" style="height:22px; width:400px;" />
        <div id="CommandErrorBox" style="height:100%; width:auto; margin-left:8px; vertical-align:center;" />
    </div>
  
    <!-- This section contains relative positioned controls. Usually dialog boxes. -->
    <div id="OpenModelDialog" styleclass="dialog-container">
        <div styleclass="dialog" style="horizontal-align:right; padding-top:20px; flex-child-height:true">
            <div id="OpenModelDialog_FileExplorer" styleclass="file-explorer" style="border-bottom:1px #999; padding-bottom:8px;" />
            <div style="width:auto; height:auto; margin-top:8px; child-plane:horizontal; transparent-mouse-input:true;">
                <div id="btnOpenModelDialog_Open"  styleclass="button" style="margin-right:4px; width:100px">Open</div>
                <div id="btnOpenModelDialog_Close" styleclass="button" style="                  width:100px">Close</div>
            </div>
        </div>
    </div>
</div>
